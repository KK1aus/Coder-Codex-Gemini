# Plan 自动审核功能设计文档

**日期**: 2026-01-22
**作者**: Claude + 用户协作设计
**状态**: 设计完成，待实现

---

## 1. 目标

在 `~/.claude/CLAUDE.md` 中添加"Plan 审核协议"，让所有生成 implementation plan 的场景自动触发 Reviewer 审核，并根据反馈自动迭代直到通过或达到迭代上限（3次）。

## 2. 背景与动机

在使用 `ccg` 开发新功能时，经常遇到以下问题：
- `superpowers:writing-plans` 生成的 plan 需要人工 review
- 用户总是手动指派 `ccg-reviewer` 来审核 plan
- 手动流程效率低，容易遗漏

**期望效果**：自动化 plan 审核，提升代码质量保障能力。

## 3. 架构设计

### 3.1 整体架构

基于全局协议的自动化审核流程。核心思想是将"plan 审核"作为强制步骤嵌入到 Claude 的工作流程中。

**流程图**：
```
创建/修改 Plan 文件
    ↓
检测触发条件（文件路径 + 内容特征）
    ↓
调用 Reviewer (mcp__ccg__reviewer)
    ↓
解析审核结果
    ↓
┌─────────────────┐
│ ✅ 通过         │ → 继续执行
│ ❌/⚠️ 需要修改  │ → 自动修复 + 重新审核
└─────────────────┘
    ↓
迭代计数 +1
    ↓
是否达到 3 次？
    ↓ Yes → 报告用户，降级处理
    ↓ No  → 继续审核
```

### 3.2 关键技术点

- **触发检测**：文件路径模式（`docs/plans/*.md`）+ 内容特征检测
- **MCP 工具**：复用现有 `mcp__ccg__reviewer`
- **错误处理**：达到迭代上限后的降级策略
- **SESSION_ID 管理**：独立于 coder 的 session

## 4. 协议内容设计

### 4.1 新增章节结构

在 `~/.claude/CLAUDE.md` 中添加 `## Plan 审核协议`，包含：

1. **强制规则声明**
   - 所有 implementation plan 必须经过 Reviewer 审核
   - 审核不通过不得进入执行阶段

2. **触发条件定义**
   - 文件路径匹配：`docs/plans/*.md`、`docs/designs/*.md`
   - 内容特征：包含 "Implementation Plan"、"Architecture"、"Tech Stack"
   - 操作类型：创建或修改 plan 文件

3. **审核流程定义**
   - 调用 `mcp__ccg__reviewer` 的具体步骤和参数
   - Prompt 模板（见 4.2）

4. **迭代策略**
   - 最大迭代次数：3 次
   - 自动修复规则
   - 降级处理流程

5. **例外情况**
   - 简单 bug 修复 plan 可跳过审核
   - 用户显式要求跳过

### 4.2 Prompt 模板

```markdown
请 review 以下 implementation plan：

**文件路径**：{plan_file_path}

**审核标准**：
1. 完整性：是否包含所有必要章节（目标、架构、任务分解）
2. 可行性：任务是否具体可执行，是否有清晰的验收标准
3. 最佳实践：是否遵循 DRY、YAGNI、TDD 原则
4. 文件路径：所有文件路径是否准确
5. 代码示例：是否提供完整的代码示例

**请给出明确结论**：
- ✅ 通过：plan 质量良好，可以执行
- ⚠️ 建议优化：[具体建议]
- ❌ 需要修改：[具体问题]
```

### 4.3 与现有协议的关系

- 与"强制规则"并列
- 复用 Coder-Reviewer-MCP 基础设施
- 增强 `superpowers:writing-plans` 的质量保障

## 5. 审核流程详细设计

### 5.1 步骤 1：准备审核

- 读取刚保存的 plan 文件内容
- 准备 Reviewer 的 Prompt
- 确保 `ccg-workflow` skill 已被调用

### 5.2 步骤 2：调用 Reviewer

**MCP 工具参数**：
- `PROMPT`：plan 文件路径 + 审核标准
- `cd`：当前工作目录
- `sandbox`：`read-only`
- 保存返回的 `SESSION_ID`

### 5.3 步骤 3：处理审核结果

- **✅ 通过**：标记完成，继续执行
- **⚠️/❌ 需要修改**：
  - 解析反馈意见
  - Claude 自动修改 plan 文件
  - 迭代计数器 +1
  - 如果 < 3 次：重新审核
  - 如果 == 3 次：报告用户

### 5.4 步骤 4：降级处理

达到迭代上限时的处理：
```
报告："Plan 审核未能在 3 次迭代内通过，需要手动处理"
显示 Reviewer 的最后反馈
询问用户：
A) 手动修改 plan
B) 放弃审核继续执行
C) 其他处理
```

## 6. SESSION_ID 管理

- Plan 审核使用独立的 `review_session_id`
- 与 `coder_session_id` 分开存储
- 每次迭代使用 Reviewer 返回的新 SESSION_ID
- 内存维护：`{"plan_review_session": "xxx", "iteration_count": 0}`

## 7. 边界情况处理

| 情况 | 处理策略 |
|------|---------|
| 文件读取失败 | 报告错误，跳过审核 |
| Reviewer 调用失败 | 重试 1 次，仍失败则报告用户 |
| 返回格式异常 | 报告用户原始输出 |
| Plan 文件被删除 | 终止审核 |
| 用户中断 | 立即终止并保存当前状态 |

## 8. 与现有流程的集成

- **superpowers:writing-plans**：在"保存 plans"步骤后插入审核流程
- **ccg-workflow**：先调用 skill，然后使用其指导调用 MCP 工具
- **强制规则**：plan 审核作为新的强制规则

## 9. 测试策略

实现后测试以下场景：

1. ✅ 创建新的 plan 文件 → 应触发审核
2. ✅ 修改现有 plan 文件 → 应触发审核
3. ✅ 审核通过 → 继续执行
4. ✅ 审核失败 + 3 次内修复通过 → 继续执行
5. ✅ 审核失败 + 达到迭代上限 → 报告用户

## 10. 实现检查清单

- [ ] 在 `~/.claude/CLAUDE.md` 添加"Plan 审核协议"章节
- [ ] 测试审核流程是否正常触发
- [ ] 测试迭代机制是否正常工作
- [ ] 测试边界情况处理
- [ ] 验证与 `superpowers:writing-plans` 的集成
- [ ] 验证与 `ccg-workflow` 的集成

---

## 附录：关键决策记录

| 决策点 | 选择 | 理由 |
|--------|------|------|
| 触发时机 | 保存后自动触发 | 完全自动化，无需用户介入 |
| 实现位置 | CLAUDE.md 全局协议 | 简单直接，无需修改 skill 文件 |
| 适用范围 | 所有 implementation plan | 通用化，灵活可扩展 |
| 迭代策略 | 自动修复 + 3 次上限 | 平衡自动化和可控性 |
